---
title: "ASM -  Local polynomial regression"
author: "Sergi Carol, Laura Cebollero, Alex Rodriguez"
date: "21st November, 2018"
output: pdf_document
---

```{rsetup, include=FALSE}
library(KernSmooth)
library(sm)
library(esquisse)

data(aircraft)
attach(aircraft)

source("locpolreg.R")

```

# Introduction
In this deliverable we will perform some calculation in order to estimate the conditional variance on a local polynomial regression model. In this case we will use data from different aircrafts over the years, mainly focusing on how does the _weight_ of the aircrafts change over the years. Due to the difference in scale of the raw weight data we will beging by transforming the __weight__ attribute into logarithmic scale.

```{r}
lgWeight <- log(Weight)
```


```{r}
source("functions.R")
# We use the functions to calculate the optimal value for the bandwidth. 
# The methods used are cross-validation, generalized cross-validation, 10-fold
# cross-validation and Plug-In
choose.best.bw <- function(x, y){
  cvh.bw <- h.cv.gcv(x, y)
  dpill.bw <- dpill(x, y, range.x = range(x))
  k.cv.bw <- h.k.fold.cv(x, y)
  
  cv.mean <- mean(cvh.bw[["cv"]])
  gcv.mean <- mean(cvh.bw[["gcv"]])
  kf.cv.mean <- mean(k.cv.bw[["k.cv"]])
  
  mean.bw = mean(c(cv.mean, gcv.mean, kf.cv.mean, dpill.bw))
  
  return(mean.bw)
}
```

```{r}
plot(Yr, lgWeight)

# bw <- bw.chooser(Yr, lgWeight)
bw <- choose.best.bw(Yr, lgWeight)
m1 <- locpoly(Yr, lgWeight, bandwidth = bw, degree=1, drv=0, gridsize = length(Yr))
points(m1, col="red", type='l', lwd=3)

e <- lgWeight - m1$y
summary(e)
# Error compared to our data
plot(Yr, e^2)
z <- log(e^2)

summary(z)

z[is.infinite(z)] <- 0 # Last value is infinite so we better change it to 0

# Choose Bandwidth
bw <- choose.best.bw(Yr, z)
q <- locpoly(Yr, z,  bandwidth = bw, degree=1, drv=0, gridsize = length(Yr)) 
est.y <- exp(q$y)
est.x <- exp(q$x)
summary(est.y)
summary(est.x)
# How close is our estimator
points(Yr, est.y, col="red", type='l', lwd=3)
# How differnet is our error
plot(m1$x, m1$y - 1.96*sqrt(est.y), col="blue", type='l', lwd=2, xlim=c(15,90), ylim=c(6,12)) # Check this bc wtf is this plot maybe I understood it wrong
points(m1$x, m1$y + 1.96*sqrt(est.y), col="blue", type='l', lwd=2) # Check this bc wtf is this plot maybe I understood it wrong

points(Yr, lgWeight)
points(m1, col="red", type='l', lwd=4)
legend("topleft", c("expectation", "data", "model"), col=c("blue", "black", "red"), pch=15)

```


