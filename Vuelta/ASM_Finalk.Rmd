---
title: "La Vuelta"
author: "Laura Cebollero Ruiz, Alexandre Rodríguez Garau"
date: "4th January, 2019"
output: pdf_document
---

# Introduction
In this project we intend to predict the duration of the different stages of the cycling race *La Vuelta* using the information provided in the file $\texttt{Vuelta0.mtp}$. 


```{r}
library("readxl")
library("knitr")
library("ggplot2")
library("reshape2")
```

We have exported the data to an extension that R can read: `.csv`.

```{r}
data<- read.csv("Vuelta01.csv", sep = ';', header = TRUE, dec=",")
```


# Data exploration

To predict the length of the stages we will use a set that contains 14 explanatory variables and a response variable called __`ForecastedTime`__. Let's take a look at the summary of the variables:

```{r}
kable(summary(data[,1:6]))
kable(summary(data[,6:11]))
kable(summary(data[,12:16]))
```

In the previous tables we can see a short summary of the variables. __`ports1`__, __`ports2`__ and __`ports3`__ indicate the number of mountain sections in a given stage and their category (1,2 or 3). __`year`__ corresponds to the year in which this data was recorded (1 to 6). __`Week`__ is the week of the race in wich the stage takes place (1 to 3). The variables __`bef_mount`__ and __`aft_mount`__ tell us whether a stage took place before or after a mountain stage, respectively. Similarly, the variables __`bef_tt`__ and __`aft_tt`__ indicate if a stage took place before or after a time trial stage. Finally, the variable __`last`__ tells us if that stage was the last of the whole race. 

By the looks of the summary we can't seem to find any outliers or abnormal values. Most of the explanatory variables range from 0 to very low values and are natural numbers. The only continuous variables are __`ForecastedTime`__, __`Distance`__, __`HeightInc`__ and __`AccumIncr`__. This makes sense because the first variable indicates time and time is a continuous variable and the rest indicate distance which can also be continous. 

The variable __`Distance`__ seems to be quite balanced with a mean of 193 and min and max values of 111 and 264 respectively. __`HeightIncr`__, however, is the only variable that presents negative values and has very high variance. Its minimum value is -940 and the maximum value is 2310. 

By taking a closer look at the data we detect some abnormal values in the __`last`__ variable: Since this variable indicates if a stage was the last of the whole race, then there should as many stages with this value equal to 1 as years of data have been recorded. Since the recorded stages are from 6 different years then there should be 6 rows, but instead there are only 5, meaning that there is at least 1 missing stage. 

```{r}
data[data$last == 1,]$year
```

If we look at the data we can easily see that the missing value belongs to the year 3. However, this will probably not greatly affect our predicting power. There is something to be said about the variables __`year`__, __`week`__, __`bef_mount`__, __`aft_mount`__, __`bef_tt`__, __`aft_tt`__ and __`last`__: all of these variables are categorical and indicate the group or category a row belongs to. For this, we should transform these variables into factors.

```{r}
data$year      <- as.factor(data$year)
data$week      <- as.factor(data$week)
data$bef_mount <- as.factor(data$bef_mount)
data$aft_mount <- as.factor(data$aft_mount)
data$aft_tt    <- as.factor(data$aft_tt)
data$bef_tt    <- as.factor(data$bef_tt)
data$last      <- as.factor(data$last) 
```
\newpage
Now that we have transformed the categorical columns to factors we should take another look at the summary of these variables:

```{r}
kable(summary(data[,9:15]))
```

We can se that for the variables __`year`__ and __`week`__ the variables are quite balanced, each group contains a very similar amount of observations. The rest, however, are more unbalanced. `bef_mount` has more than twice 0s than 1s, which means there are twice the stages that do not precede a mountain stage. The same happens with `aft_mount`, which makes sense for it means there are only 31 stages after a mountain stage. Since they are the same numbers as the `bef_mount`, this tells us that the mountain stages are always in the middle and are not the first or last stages.

In `bef_tt` there are 9 times more stages **not** preceding a time trial stage than does preceding it. There are 4 times less after trial stages.  And finally, as mentioned before, there are only 5 last stages and 100 that are normal ones.

Let's finally take a closer look to the numerical attributes:
```{r}
num <- 6:8; num <- append(num, 16)
kable(summary(data[,1:5]))
kable(summary(data[,num]))
```

We can see that the mean and median in Time are pretty close, which means that there is not an outlier that drastically decreases or increases the mean. The same happens with Distance, AccumIncr and ForacastedTime. 

However, HeightIncr has a low Median but a high mean, which means that in general there is not a stable increase of height but some stages have a high increase of it. And we can see that there is at least one stage that consists of a decrease of almost 1km, whereas there is at least one stage of an increase of over 2km.

TODO: Comentar algo dels ports?

# Data exploration visualization

Now, in order to find outliers and to see how the data behaves we will plot some boxplots. First of all we would like to see if the forecasted times are different depending on the year in which the race took place. 

```{r}
ggplot(data = data) +
  aes(x = year, y = ForecastedTime) +
  geom_boxplot(fill = "#4292c6") +
  theme_minimal()
```

At first glance we see that the medians are really similar among all years, excepting year 3 and year 6, which are about 25 units higher. The interquartile ranges for every year are different. Even though the Q3 percentile is very similar for all years, the Q1 percentile varies from 225 to 300. It is important to say that there appears to be an outlier in the second year.

Let's take a look at real Times:
```{r}
ggplot(data = data) +
  aes(x = year, y = Time) +
  geom_boxplot(fill = "#4292c6") +
  theme_minimal()
```
 We can see how the highest Time is on the 3rd year, and there's a lot of variance on the
 1st and 5th years' races.
 The second year seems to have some stages with a very high time, so there's a lot of variance on the upper bound,
while on the 5th year there does is a lot of variance on the lower bound, meaning there are some stages with less Time than the rest. 
The 5th year is the only one where this phenomena is so visible.

 And let's compare the forecasted Times to the real Times:
```{r}
df1 <- data.frame(data$Time, data$ForecastedTime, data$year)
df2 <- melt(df1, id.vars='data.year')

ggplot(df2, aes(x=data.year, y=value, fill=variable)) +
    geom_bar(stat='identity', position='dodge')
```

We can see how the Forecasted time is pretty on par with the real time,
so the prediction is very good and varies very little in small units.

The worst predictions have been obtained on the 1st and 3rd year. And it has nailed
the predictions on the 2nd, 5th and 6th year. An overestimation has been done on the 4th year.

```{r}
ggplot(data = data) +
  aes(x = year, y = Distance) +
  geom_boxplot(fill = "#4292c6") +
  theme_minimal()
```

In the plot above we can see how for each year, the distance does not vary a lot, except on the 3rd year, where there seems to be a higher overall distance but with small variance. The 1st year seems to be the one with most variance on distances between stages and the 5th one does not seem to vary so much, except on some stages qhere the distance differs more (between 100 and past 250). The 6th year seems to be the year with less variance in distance between stages.

Since the 4th year has very little distance, it may have affected the forecasted Time, which was above the real time.

```{r}
ggplot(data = data) +
  aes(x = year, y = AccumIncr) +
  geom_boxplot(fill = "#4292c6") +
  theme_minimal()
```
Now, taking a look at the accumulated number of meters climbed on the stages for each year, 
we can see that the 2nd year is the one with most variance and, in general, most of them
vary a lot on the upper bound but not so much on the lower one.

The 3rd year seems to be the one with a highest median and the 4th one seems to be the one with the lowest one.

TODO: Fer més boxplots??
TODO: Corr plot? Pero no ho hem fet a classe..

# Generalized Linear Model

Now we are going to try to model a Generalized Linear Model for our data in order to
predict the Time.


# Prediction

In this section we are going to compare our predictions with those on the Forecasted by an expert.

